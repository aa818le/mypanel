<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Key Generator</title>
  <style>
    :root{
      --bg: #1db954;
      --text: #ffffff;
      --gap: 8px;
      --code-size: 10px;
      --max-width: 820px;
    }
    html,body{ height:100%; margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text);}
    .wrap{ min-height:100%; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:18px; box-sizing:border-box; }
    header{ width:100%; max-width:var(--max-width); display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    h1{ font-size:18px; margin:0; color:var(--text); font-weight:700; }
    button{ background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.18); color:var(--text); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; backdrop-filter: blur(4px); }
    button[disabled]{ opacity:0.6; cursor:not-allowed; }
    .panel{ width:100%; max-width:var(--max-width); background: rgba(0,0,0,0.10); border:1px solid rgba(255,255,255,0.18); border-radius:12px; padding:12px; box-sizing:border-box; margin-bottom:12px; display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
    .field{ display:flex; flex-direction:column; gap:6px; min-width:180px; flex:1; }
    .field label{ font-size:12px; opacity:0.9; }
    .field input{ background:rgba(255,255,255,0.12); color:var(--text); border:1px solid rgba(255,255,255,0.18); border-radius:8px; padding:10px 12px; outline:none; font-weight:600; }
    .field input::placeholder{ color: rgba(255,255,255,0.7); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .list{ width:100%; max-width:var(--max-width); display:flex; flex-direction:column; gap:var(--gap); }
    .item{ font-family: "Courier New", monospace; font-size: var(--code-size); line-height:1.4; background: rgba(0,0,0,0.08); border-radius:10px; padding:10px 12px; color:var(--text); display:grid; grid-template-columns: auto 100px 80px; gap:10px; align-items:center; border:1px solid rgba(255,255,255,0.14); }
    .name{ font-weight:700; word-break: break-all; }
    .code{ opacity:0.95; word-break: break-all; display:none; }
    .timer{ text-align:right; font-weight:700; }
    .expired{ background: rgba(255,0,0,0.15); border-color: rgba(255,0,0,0.35); }
    .rowLeft{ display:flex; align-items:center; gap:10px; }
    .checkbox{ display:none; }
    .checkbox.active{ display:block; width:18px; height:18px; accent-color:#000; cursor:pointer; }
    .toolbar{ width:100%; max-width:var(--max-width); display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .toast{ position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: rgba(0,0,0,0.75); color: #fff; padding: 10px 14px; border-radius: 10px; font-weight: 600; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity .2s ease; z-index: 9999; }
    .toast.show{ opacity: 1; }
    @media (max-width:720px){ :root{ --code-size: 16px; } .item{ grid-template-columns: auto 100px 70px; } }
    @media (max-width:520px){ :root{ --code-size: 18px; } .item{ grid-template-columns: auto auto; grid-template-areas: "left left" "btn  timer"; } .name{ grid-area: left; } .copyBtn{ grid-area: btn; } .timer{ grid-area: timer; text-align:left; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Key Generator</h1>
      <div class="actions">
        <button id="createBtn">CREATE KEY</button>
      </div>
    </header>

    <div class="panel" id="createPanel" style="display:none;">
      <div class="field" style="max-width:180px;">
        <label for="minutes">Vaqt (daqiqa)</label>
        <input id="minutes" type="number" min="1" value="30" />
      </div>
      <div class="field" style="max-width:180px;">
        <label for="count">Soni (nechta key)</label>
        <input id="count" type="number" min="1" value="1" />
      </div>
      <div class="actions">
        <button id="doCreate">Create</button>
        <button id="cancelCreate">Cancel</button>
      </div>
    </div>

    <div class="toolbar">
      <button id="selectToggle">Select</button>
      <button id="deleteSelected" disabled>Delete Selected</button>
      <button id="copyAll">Copy All</button>
      <button id="deleteAll">Delete All</button>
    </div>

    <div class="list" id="list"></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const DB_URL = "https://giper-8fd92-default-rtdb.firebaseio.com";

    // 4 groups of 5 characters -> XXXXX-XXXXX-XXXXX-XXXXX
    const GROUPS = [5,5,5,5];
    const SEP = '-';
    // Characters allowed: uppercase letters and digits
    const CHARS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';

    const listEl = document.getElementById('list');
    const createBtn = document.getElementById('createBtn');
    const createPanel = document.getElementById('createPanel');
    const doCreateBtn = document.getElementById('doCreate');
    const cancelCreateBtn = document.getElementById('cancelCreate');
    const minutesInput = document.getElementById('minutes');
    const countInput = document.getElementById('count');
    const selectToggleBtn = document.getElementById('selectToggle');
    const deleteSelectedBtn = document.getElementById('deleteSelected');
    const deleteAllBtn = document.getElementById('deleteAll');
    const copyAllBtn = document.getElementById('copyAll');
    const toastEl = document.getElementById('toast');

    let selectMode = false;
    const liveTimers = new Map();

    function showToast(text){
      toastEl.textContent = text;
      toastEl.classList.add('show');
      setTimeout(()=> toastEl.classList.remove('show'), 1200);
    }

    function randChar(){ return CHARS.charAt(Math.floor(Math.random()*CHARS.length)); }
    function makeCode(){ 
      return GROUPS.map(len=>{
        let s='';
        for(let i=0;i<len;i++) s+=randChar();
        return s;
      }).join(SEP); 
    }
    function msUntil(ts){ return Math.max(0, (ts||0) - Date.now()); }
    function formatTimeLeft(ms){ const sec = Math.floor(ms/1000); const m = Math.floor(sec/60); const s = sec % 60; return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    function autoName(idx=1){ return `••••••••••••••••••••`; }

    async function dbGet(path){
      const url = `${DB_URL}/${path}.json`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('DB GET failed');
      return res.json();
    }
    async function dbPut(path, data){
      const url = `${DB_URL}/${path}.json`;
      const res = await fetch(url, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
      if(!res.ok) throw new Error('DB PUT failed');
      return res.json();
    }
    async function dbDelete(path){
      const url = `${DB_URL}/${path}.json`;
      const res = await fetch(url, { method: 'DELETE' });
      if(!res.ok) throw new Error('DB DELETE failed');
      return true;
    }

    function clearTimers(){ for(const [,tid] of liveTimers) clearInterval(tid); liveTimers.clear(); }

    function renderList(obj){
      listEl.innerHTML = '';
      clearTimers();
      if(!obj) return;
      const entries = Object.entries(obj).filter(([k,v]) => v && typeof v === 'object').sort((a,b)=> (b[1]?.createdAt||0) - (a[1]?.createdAt||0));
      for(const [dbKey, data] of entries){
        const row = document.createElement('div');
        row.className = 'item';
        row.dataset.key = dbKey;
        const left = document.createElement('div');
        left.className = 'rowLeft';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.className = 'checkbox' + (selectMode ? ' active' : '');
        cb.addEventListener('change', updateDeleteSelectedState);
        const nm = document.createElement('div');
        nm.className = 'name';
        nm.textContent = data.name || dbKey;
        left.appendChild(cb);
        left.appendChild(nm);
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copyBtn';
        copyBtn.textContent = 'Copy';
        copyBtn.addEventListener('click', ()=> copyCode(data.code));
        const timer = document.createElement('div');
        timer.className = 'timer';
        const ms = msUntil(data.expiresAt);
        if(ms <= 0){
          timer.textContent = 'Expired';
          row.classList.add('expired');
          copyBtn.disabled = true;
        }else{
          timer.textContent = formatTimeLeft(ms);
          const tid = setInterval(()=>{
            const leftMs = msUntil(data.expiresAt);
            if(leftMs <= 0){
              clearInterval(tid);
              row.classList.add('expired');
              timer.textContent = 'Expired';
              copyBtn.disabled = true;
            }else{
              timer.textContent = formatTimeLeft(leftMs);
            }
          }, 1000);
          liveTimers.set(dbKey, tid);
        }
        row.appendChild(left);
        row.appendChild(copyBtn);
        row.appendChild(timer);
        listEl.appendChild(row);
      }
    }

    function getSelectedNames(){
      return [...listEl.querySelectorAll('.item')].filter(r => r.querySelector('.checkbox').checked).map(r => r.dataset.key);
    }

    function updateDeleteSelectedState(){
      deleteSelectedBtn.disabled = getSelectedNames().length === 0;
    }

    async function purgeExpired(){
      const all = await dbGet('users');
      if(!all){ renderList(null); return; }
      const now = Date.now();
      for(const [name, data] of Object.entries(all)){
        if((data.expiresAt||0) <= now){
          await dbDelete(`users/${encodeURIComponent(name)}`);
        }
      }
      const after = await dbGet('users');
      renderList(after);
    }

    async function createKeys(){
      const minutes = Math.max(1, parseInt(minutesInput.value || '60', 10));
      const count = Math.max(1, parseInt(countInput.value || '1', 10));
      const createdAt = Date.now();
      const expiresAt = createdAt + minutes*60*1000;
      const existing = await dbGet('users') || {};
      for(let i=0;i<count;i++){
        let code = makeCode();
        while(existing[code]){ code = makeCode(); }
        existing[code] = true;
        const display = autoName(i+1);
        const data = { name: display, code, createdAt, expiresAt };
        await dbPut(`users/${encodeURIComponent(code)}`, data);
      }
      const fresh = await dbGet('users');
      renderList(fresh);
      toggleCreatePanel(false);
      showToast('Keys created');
    }

    async function deleteSelected(){
      for(const k of getSelectedNames()){ await dbDelete(`users/${encodeURIComponent(k)}`); }
      renderList(await dbGet('users'));
    }

    async function deleteAll(){
      await dbDelete('users');
      renderList(await dbGet('users'));
    }

    async function copyCode(text){
      if(!text) return;
      try{
        await navigator.clipboard.writeText(text);
        showToast('Copied');
      }catch(e){ showToast('Copy failed'); }
    }

    async function copyAllKeys(){
      const rows = [...listEl.querySelectorAll('.item')];
      if(rows.length === 0){ showToast('No keys'); return; }
      let text = '';
      rows.forEach((r, idx) => { text += `Kay_${idx+1} ${r.dataset.key}\n`; });
      try{
        await navigator.clipboard.writeText(text.trim());
        showToast('All keys copied');
      }catch(e){ showToast('Copy failed'); }
    }

    function toggleSelectMode(on){
      selectMode = (typeof on === 'boolean') ? on : !selectMode;
      listEl.querySelectorAll('.checkbox').forEach(cb=>{
        cb.classList.toggle('active', selectMode);
        if(!selectMode) cb.checked=false;
      });
      updateDeleteSelectedState();
      selectToggleBtn.textContent = selectMode ? 'Cancel Select' : 'Select';
    }

    function toggleCreatePanel(show){
      createPanel.style.display = show ? 'flex' : 'none';
    }

    createBtn.addEventListener('click', ()=> toggleCreatePanel(true));
    cancelCreateBtn.addEventListener('click', ()=> toggleCreatePanel(false));
    doCreateBtn.addEventListener('click', createKeys);
    selectToggleBtn.addEventListener('click', ()=> toggleSelectMode());
    deleteSelectedBtn.addEventListener('click', deleteSelected);
    deleteAllBtn.addEventListener('click', deleteAll);
    copyAllBtn.addEventListener('click', copyAllKeys);

    (async function init(){ await purgeExpired(); })();
  </script>
</body>
      </html>
